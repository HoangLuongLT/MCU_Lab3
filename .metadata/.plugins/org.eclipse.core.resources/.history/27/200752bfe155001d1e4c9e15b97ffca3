/*
 * input_processing.c
 *
 *  Created on: Oct 24, 2022
 *      Author: Luong
 */

#include "main.h"
#include "input_reading.h"
#include "output_display.h"
#include "software_timer.h"

enum Mode{NORMAL,NORMAL1,NORMAL2,NORMAL3,MODIFY_RED, MODIFY_YELLOW, MODIFY_GREEN} ;
enum Mode mode = NORMAL;
int mode_counter=0;
int redDuration = 15;
int greenDuration = 10;
int yellowDuration = 5;


int increase = 0;

int cnt = 0;
int change =0;

// value of time duration must be: green+yellow=red
void fsm_mode_processing(void){
	switch(mode){
	//timer0 use to exit button state 50ms
	//timer1 use to blink led 2hz
	case NORMAL:
		if(timer3_flag==1){
			setTimer3(500);
			if(change==0){
				display7SEGMode((int)(redDuration-cnt)/10);
				display7SEGValue((int)(greenDuration-cnt)/10);
			}
			else{
				display7SEGMode((redDuration-cnt)%10);
				display7SEGValue((greenDuration-cnt)%10);
				if((++cnt)==greenDuration){
					mode=NORMAL1;
				}
			}
			change=!change;
		}
		if(timer2_flag==1){
			setTimer2(1000);
			turnOffAll();
			turnOnOnlyRed(0);
			turnOnOnlyGreen(1);
		}
		if(is_button_pressed(0)){
			setTimer0(50);
			timer1_flag=1;
			//INCREASE VALUE OF PORT A BY ONE UNIT
		}
		if(timer0_flag==1) {
			timer0_flag=0;
			display7SEGMode(++mode_counter);
			mode=MODIFY_RED;
		}

		break;
	case NORMAL1:
		if(timer3_flag==1){
			setTimer3(500);
			if(change==0){
				display7SEGMode((int)(redDuration-cnt)/10);
				display7SEGValue((int)(redDuration-cnt)/10);
			}
			else{
				display7SEGMode((redDuration-cnt)%10);
				display7SEGValue((redDuration-cnt)%10);
				if((++cnt)==redDuration){
					mode=NORMAL2;
				}
			}
			change=!change;
		}
		if(timer2_flag==1){
			setTimer2(1000);
			turnOffAll();
			turnOnOnlyRed(0);
			turnOnOnlyYellow(1);
		}

		if(is_button_pressed(0)){
			setTimer0(50);
			timer1_flag=1;
			//INCREASE VALUE OF PORT A BY ONE UNIT
		}
		if(timer0_flag==1) {
			timer0_flag=0;
			display7SEGMode(++mode_counter);
			mode=MODIFY_RED;
		}
		break;
	case NORMAL2:
		if(timer3_flag==1){
			setTimer3(500);
			if(change==0){
				display7SEGValue((int)(2*redDuration-cnt)/10);
				display7SEGMode((int)(redDuration+greenDuration-cnt)/10);
			}
			else{
				display7SEGValue((2*redDuration-cnt)%10);
				display7SEGMode((redDuration+greenDuration-cnt)%10);
				if((++cnt)==redDuration+greenDuration){
					mode=NORMAL3;
				}
			}
			change=!change;
		}
		if(timer2_flag==1){
			setTimer2(1000);
			turnOffAll();
			turnOnOnlyGreen(0);
			turnOnOnlyRed(1);
		}

		if(is_button_pressed(0)){
			setTimer0(50);
			timer1_flag=1;
			//INCREASE VALUE OF PORT A BY ONE UNIT
		}
		if(timer0_flag==1) {
			timer0_flag=0;
			display7SEGMode(++mode_counter);
			mode=MODIFY_RED;
		}
		break;
	case NORMAL3:
		if(timer3_flag==1){
			setTimer3(500);
			if(change==0){
				display7SEGValue((int)(2*redDuration-cnt)/10);
				display7SEGMode((int)(2*redDuration-cnt)/10);
			}
			else{
				display7SEGValue((2*redDuration-cnt)%10);
				display7SEGMode((2*redDuration-cnt)%10);
				if((++cnt)==2*redDuration){
					mode=NORMAL;
					cnt=0;
				}
			}
			change=!change;
		}

		if(timer2_flag==1){
			setTimer2(1000);
			turnOffAll();
			turnOnOnlyYellow(0);
			turnOnOnlyRed(1);
		}

		if(is_button_pressed(0)){
			setTimer0(50);
			timer1_flag=1;
			//INCREASE VALUE OF PORT A BY ONE UNIT
		}
		if(timer0_flag==1) {
			timer0_flag=0;
			display7SEGMode(++mode_counter);
			mode=MODIFY_RED;
		}
		break;
	case MODIFY_RED:
		if(is_button_pressed(1)){
			setTimer2(50);
		}
		if(timer2_flag==1){
			increase++;
		}
		if(is_button_pressed(2)){
			setTimer4(50);
		}
		if(timer4_flag==1){
			if(increase!=0)
			redDuration+=increase;
		}
		if(is_button_pressed(0)){
			setTimer0(50);
			//INCREASE VALUE OF PORT A BY ONE UNIT
		}
		if(timer0_flag==1) {
			timer0_flag=0;
			display7SEGMode(++mode_counter);
			mode=MODIFY_YELLOW;
		}
		if(timer1_flag==1){
			setTimer1(500);
			blinkAllRedLed();
		}
		if(timer3_flag==1){
			setTimer3(500);
			if(change==0){
				display7SEGValue((int)(redDuration)/10);
			}
			else{
				display7SEGValue((redDuration)%10);
			}
			change=!change;
		}
		break;
	case MODIFY_YELLOW:
		if(is_button_pressed(1)){
			setTimer2(50);
		}
		if(timer2_flag==1){
			increase++;
		}
		if(is_button_pressed(2)){
			setTimer4(50);
		}
		if(timer4_flag==1){
			if(increase!=0){
				yellowDuration+=increase;
				increase=0;
			}
		}
		if(is_button_pressed(0)){
			setTimer0(50);
			//INCREASE VALUE OF PORT A BY ONE UNIT
		}
		if(timer0_flag==1) {
			timer0_flag=0;
			display7SEGMode(++mode_counter);
			mode=MODIFY_GREEN;
		}
		if(timer1_flag==1){
			setTimer1(500);
			blinkAllYellowLed();
		}
		if(timer3_flag==1){
			setTimer3(500);
			if(change==0){
				display7SEGValue((int)(greenDuration)/10);
			}
			else{
				display7SEGValue((greenDuration)%10);
			}
			change=!change;
		}
		break;
	case MODIFY_GREEN:
		if(is_button_pressed(1)){
			setTimer2(50);
		}
		if(timer2_flag==1){
			increase++;
		}
		if(is_button_pressed(2)){
			setTimer4(50);
		}
		if(timer4_flag==1){
			greenDuration+=increase;
			increase=0;
		}
		if(is_button_pressed(0)){
			setTimer0(50);
			//INCREASE VALUE OF PORT A BY ONE UNIT
		}
		if(timer0_flag==1) {
			timer0_flag=0;
			display7SEGMode(mode_counter);
			mode_counter=0;
			mode=NORMAL;
		}
		if(timer1_flag==1){
			setTimer1(500);
			blinkAllGreenLed();
		}
		if(timer3_flag==1){
			setTimer3(500);
			if(change==0){
				display7SEGValue((int)(yellowDuration)/10);
			}
			else{
				display7SEGValue((yellowDuration)%10);
			}
			change=!change;
		}
		break;
	}
}
